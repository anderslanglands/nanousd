# NanoUSD Project Rules

NanoUSD is a C wrapper library for Pixar's USD (Universal Scene Description) library with Python bindings. It provides a simplified C API for working with USD files, with a ctypes-based Python wrapper.

## Build Commands

All commands run from project root using `just`:

```bash
just configure    # Configure CMake (user runs when needed)
just build        # Build the C library
just test         # Run C tests via CTest
just bind         # Generate Python bindings (CRITICAL: run after ANY header changes)
just pytest       # Run Python tests (primary testing method)
just pyexample    # Run Python example
just docs         # Generate documentation
```

## Critical Development Rules

### After Modifying C Headers
**ALWAYS run `just bind` after modifying ANY `.h` file** to regenerate Python bindings. The ctypesgen warnings from system headers can be safely ignored.

### Never Edit ffi.py
The file `python/nanousd/ffi.py` is auto-generated by ctypesgen. **Never edit it manually** - changes will be overwritten.

### Primary Testing
Use `just pytest` as the primary testing method - it covers both C and Python functionality.

## Project Structure

### C Library (`libnanousd/`)

**Core Files:**
- `nanousd.h` - Main header aggregating all modular headers
- `nanousd.cpp` - Core stage management, prim operations, path utilities
- `nanousd-types.h` - Type definitions, error codes, constants

**Specialized Modules:**
- `nanousd-array.h/.cpp` - Array type definitions and functions
- `nanousd-property.h/.cpp` - Property/attribute access with type support
- `nanousd-prim.h/.cpp` - Prim operations, transforms, primvars
- `nanousd-mesh.h/.cpp` - Mesh geometry operations
- `nanousd-light.h/.cpp` - Light creation (rect, disk, sphere, dome)

**Header-only Modules:**
- `nanousd-iterator.h` - Iterator definitions
- `nanousd-camera.h` - Camera functionality
- `nanousd-material.h` - Material and shader system

**Tests (`libnanousd/tests/`):**
- `nusd_test.cpp` - Main test file
- `nusd_test-camera.cpp` - Camera tests
- `nusd_test-light.cpp` - Light tests
- `nusd_test-material.cpp` - Material tests
- `nusd_test-mesh.cpp` - Mesh tests
- `nusd_test-prim.cpp` - Prim tests
- `nusd_test-property.cpp` - Property tests

### Python Bindings (`python/`)

**Package (`nanousd/`):**
- `__init__.py` - Stage class, iterators, exceptions
- `ffi.py` - Auto-generated ctypes bindings (DO NOT EDIT)
- `tokens.py` - USD type constants and enumerations
- `array.py` - NumPy-compatible array wrappers
- `_get_property.py` - Property retrieval logic
- `_set_property.py` - Property setting logic

**Tests (`python/tests/`):**
- `test_nanousd.py` - Main tests
- `test_mesh.py` - Mesh tests
- `test_light.py` - Light tests
- `test_primvars.py` - Primvar tests
- `test_color_space.py` - Color space tests
- `test_material_functions.py` - Material tests
- `test_shader_connect.py` - Shader connection tests
- `test_string.py` - String type tests

## C API Patterns

### Error Handling
All C functions return `nusd_result_t`. Always check for `NUSD_RESULT_OK`.

**Error Codes:**
- `NUSD_RESULT_OK` - Success
- `NUSD_RESULT_NULL_PARAMETER` - Null pointer passed
- `NUSD_RESULT_INVALID_PRIM_PATH` - Prim doesn't exist
- `NUSD_RESULT_INVALID_ATTRIBUTE_PATH` - Attribute doesn't exist
- `NUSD_RESULT_DEFINE_PRIM_FAILED` - Couldn't create prim
- `NUSD_RESULT_INVALID_INTERPOLATION` - Invalid interpolation enum value
- `NUSD_RESULT_INVALID_SUBDIVISION_SCHEME` - Invalid subdivision scheme enum
- `NUSD_RESULT_INVALID_TRIANGLE_SUBDIVISION_RULE` - Invalid triangle subdivision rule enum

### Enum Types with Typedefs
For ctypesgen compatibility, enums need a corresponding `typedef int`:

```c
enum nusd_something_e {
    NUSD_SOMETHING_VALUE1 = 0,
    NUSD_SOMETHING_VALUE2 = 1,
};
typedef int nusd_something_t;  // Required for ctypesgen
```

Use the `_t` typedef in function signatures, not the `_e` enum directly.

### Current Enums

**Interpolation (`nanousd-prim.h`):**
- `NUSD_INTERPOLATION_CONSTANT` (0)
- `NUSD_INTERPOLATION_UNIFORM` (1)
- `NUSD_INTERPOLATION_VERTEX` (2)
- `NUSD_INTERPOLATION_VARYING` (3)
- `NUSD_INTERPOLATION_FACEVARYING` (4)

**Subdivision Scheme (`nanousd-mesh.h`):**
- `NUSD_SUBDIVISION_SCHEME_NONE` (0) - Polygonal mesh
- `NUSD_SUBDIVISION_SCHEME_CATMULL_CLARK` (1) - Default, for quads
- `NUSD_SUBDIVISION_SCHEME_LOOP` (2) - For triangles
- `NUSD_SUBDIVISION_SCHEME_BILINEAR` (3)

**Triangle Subdivision Rule (`nanousd-mesh.h`):**
- `NUSD_TRIANGLE_SUBDIVISION_RULE_CATMULL_CLARK` (0)
- `NUSD_TRIANGLE_SUBDIVISION_RULE_SMOOTH` (1)

### Function Naming Convention
- `nusd_stage_*` - Stage operations
- `nusd_prim_*` - Prim operations
- `nusd_attribute_*` - Attribute operations
- `nusd_mesh_*` - Mesh operations
- `nusd_camera_*` - Camera operations
- `nusd_material_*` / `nusd_shader_*` - Material/shader operations
- `nusd_*_light_define` - Light creation (rect, disk, sphere, dome)

## Python Wrapper Patterns

### Adding New C Functions to Python

1. **Run `just bind`** after modifying headers
2. Add wrapper method to `Stage` class in `__init__.py`
3. Export any new constants in `tokens.py`
4. Add tests

### Standard Method Pattern
```python
def method_name(self, path: str, value: type):
    result = _lib.nusd_c_function(
        self._stage,
        path.encode("ascii"),
        c_type(value)
    )
    if result == _lib.NUSD_RESULT_SPECIFIC_ERROR:
        raise SpecificError(f'specific message for "{path}"')
    elif result != _lib.NUSD_RESULT_OK:
        raise GeneralError(f'failed for "{path}": {result}')
```

### Key Patterns

**String encoding:** `path.encode("ascii")`

**Enum parameters:** Wrap with `c_int()`:
```python
result = _lib.nusd_function(self._stage, path.encode("ascii"), c_int(enum_value))
```

**Array input (NumPy):**
```python
result = _lib.nusd_function(
    self._stage,
    path.encode("ascii"),
    array.ctypes.data_as(POINTER(c_float)),
    len(array)
)
```

**Output parameters:**
```python
output = c_type()
result = _lib.nusd_function(self._stage, path.encode("ascii"), byref(output))
return output.value
```

### Exception Classes
- `StageOpenError` - Stage opening failures
- `StageCreateError` - Stage creation failures
- `DefinePrimError` - Prim/object creation failures
- `CreatePropertyError` - Property creation failures
- `SetPropertyError` - Setting values, validation errors
- `GetPropertyError` - Getting values, path not found
- `ShaderConnectError` - Shader connection failures
- `MaterialBindError` - Material binding failures

### Exporting Constants in tokens.py
```python
from . import ffi as _lib

# Type constants
FLOAT = _lib.NUSD_TYPE_FLOAT
FLOAT3 = _lib.NUSD_TYPE_FLOAT3

# Interpolation enum values
INTERPOLATION_VERTEX = _lib.NUSD_INTERPOLATION_VERTEX
INTERPOLATION_FACEVARYING = _lib.NUSD_INTERPOLATION_FACEVARYING

# Subdivision scheme enum values
SUBDIVISION_SCHEME_NONE = _lib.NUSD_SUBDIVISION_SCHEME_NONE
SUBDIVISION_SCHEME_CATMULL_CLARK = _lib.NUSD_SUBDIVISION_SCHEME_CATMULL_CLARK
```

## Testing Patterns

### C Tests (GoogleTest)
```cpp
TEST(nusd, test_name) {
    nusd_stage_t stage;
    nusd_result_t result = nusd_stage_create_in_memory("test-name", &stage);
    EXPECT_EQ(result, NUSD_RESULT_OK);
    
    // Test operations...
    
    // Test error cases
    EXPECT_EQ(nusd_function(nullptr, ...), NUSD_RESULT_NULL_PARAMETER);
    EXPECT_EQ(nusd_function(stage, "/Invalid", ...), NUSD_RESULT_INVALID_PRIM_PATH);
    
    nusd_stage_destroy(stage);
}
```

### Python Tests (pytest)
```python
def test_feature_name():
    stage = nusd.Stage.create_in_memory("test_feature_name")
    stage.define_prim("/World", "Xform")
    
    # Test operations...
    
    # Test error cases
    with pytest.raises(nusd.SetPropertyError):
        stage.operation_that_fails(...)
```

## Key Functionality

### Mesh Operations
- `mesh_define()` - Create mesh with vertices, faces, indices
- `mesh_set_normals()` - Set normals with interpolation enum
- `mesh_set_subdivision_scheme()` - Set subdivision scheme and triangle rule

### Light Types
- `rect_light_define()` - Rectangular area light
- `disk_light_define()` - Circular disk light
- `sphere_light_define()` - Spherical light
- `dome_light_define()` - Environment/dome light with optional HDRI

### Material System
- `material_define()` - Create material
- `shader_define()` - Create shader with ID
- `shader_create_input()` / `shader_create_output()` - Create I/O
- `shader_connect()` - Connect shader network
- `material_bind()` - Bind material to prim

### Transform System
- `prim_set_transform()` - Set 4x4 transform matrix
- `prim_add_translate_op()` - Add translation operation
- `prim_compute_local_to_world_transform()` - Compute world transform

### Property System
- All USD types supported (float, double, int, vectors, matrices, arrays)
- Asset paths and token types
- Color space metadata support
- Time-coded values

## File Modification Checklist

When adding new functionality:
1. Add C function to appropriate `.h` and `.cpp` files
2. Add error codes to `nanousd-types.h` if needed
3. Add enums with `typedef int` for ctypesgen compatibility
4. Run `just bind` to regenerate Python bindings
5. Add Python wrapper to `__init__.py`
6. Export new constants in `tokens.py`
7. Add C test to appropriate `nusd_test-*.cpp`
8. Add Python test to appropriate `test_*.py`
9. Run `just test` and `just pytest` to verify

